---
title: MastodonのURLは、一度立てた後は変更してはいけない
permalink: /p/bdf63d2112544717ac9858a5b53aeb87
tags: []
date: 2018-08-04 03:00:00
updated: 2021-07-29 02:18:51
---

## 環境

Mastodon 2.3.3

## やったこと

元々、mastodon.example.com で運用していた（アカウント名は `hoge@example.com`)

（要するに、.env.production で WEB_DOMAIN を指定してアカウント名と実際マストドンにアクセスする URL を変えていた）

いくつかのクライアントが、返信する際に、 `hoge@mastodon.example.com` と書いて返信して

しまうようだったので、マストドン自体の URL も example.com でアクセスできるように、

WEB_DOMAIN の指定を消したところ、トラブルに遭遇した。

## 現象

トゥートを行うと、SideKiq の push ジョブが失敗して、retry キューに溜まってしまう。

現象はこの Issue の通り

<https://github.com/tootsuite/mastodon/issues/6667>

## 対処

基本的には、対処方法はありません。元に戻すしかありません。。

しかも、URL 変更中に作成されたアカウント、かつ他インスタンスに登録されてしまうと、

戻したとしても新しいアカウントについて同じことが発生してしまいます。

しかし、Issue を見ると、他のインスタンスに既に登録されたアカウントと、URL の対応を変更する事ができず

アカウント名重複エラーとなっているようなので、自インスタンス側の全てのアカウントを作り直すことで

対応できます。（今回はほぼお一人様インスタンスだったので、こちらを選択しました）

## 蛇足

アカウントと URL の対応の変更、下手に出来ちゃうとアカウント乗っ取りが可能になりかねないので

なかなか難しいのでしょうね。

## 追記

2.8 くらいで、ユーザーを作り直す的なコマンドが toot-ctl に追加されているので、この記事の内容は古いかもしれません。
